<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, 
initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>New-Era</title>
    <link rel="stylesheet" 
href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
    <style>
        #map {
            height: 500px;
            width: 500px;
            float: right;
        }
        h1 {
            text-align: center;
        }
        #data {
            display: inline;
        }
        #info {
            margin-top: 10%;
            float: left;
        }
    </style>
</head>

<body>
    <header class="jumbotron jumbotron-fluid">
        <div class="container">
            <h1>New-ERA</h1>
        </div>
    </header>
    <div class="container">
        <div>
            <input type="text" id="text-input" placeholder="Enter message" >
            <input type="text" id="auth-input" placeholder="Enter auth token" >
            <input type="submit" class="btn btn-primary" onclick="submit();">
            <div id="data">
                <div id="info">
                    <h4 id="int">Expected Intensity: </h4>
                    <p id="loc">Estimated Location: </p>
                    <p id="time">Estimated time until shaking: </p>
                </div>
            </div>
            <div id="map"></div>
            <button class="btn btn-info" onclick="demo();">demo</button>
        </div>
    </div>
    <script>
        let sock;
        var map;
        var marker;
        var bounds;  

        function initMap(lat, long) {
            if ((lat == null) || (long == null)) {
                lat = parseFloat(-34.397)
                long = parseFloat(150.644)
            }
            bounds = new google.maps.LatLngBounds(); 
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: lat, lng: long},
                zoom: 8
            
            });

            marker = new google.maps.Marker({
                position: map.center,
                map: map,
                title: 'Location of earthquake'
            });
            bounds.extend(marker.position)
        }

        function demo() {
            const http = new XMLHttpRequest();

            http.open("GET", "https://api.bfranzen.me/test")
            http.send();
        }
        function submit() {
            let token = document.getElementById("auth-input").value;
            let clientMsg = document.getElementById("text-input").value;
            let res = document.getElementById("data");
            console.log(clientMsg);
            sock = new WebSocket("wss://api.bfranzen.me/ws?auth=" + token);
            sock.onopen = () => {
                console.log("Connection Opened");
                sock.send(clientMsg);
            };
            sock.onclose = () => {
                console.log("Connection Closed");
            };
            sock.onmessage = (msg) => {
                
                function IsJsonString(str) {
                    try {
                        JSON.parse(str);
                    } catch (e) {
                        return false;
                    }
                    return true;
                }
                if (IsJsonString(msg.data)) {
                    let m = JSON.parse(msg.data)
                    console.log(m)
                    let loc = m.location
                    let res = loc.split(",")
                    //map.center = {lat : parseFloat(res[0]), lng: parseFloat(res[1])}
                    //console.log(map.center)
                    //initMap(parseFloat(res[0]), parseFloat(res[1]))
                    initMap(parseFloat(res[0]), parseFloat(res[1]))

                    var circle = new google.maps.Circle({
                        map: map,
                        radius: 16000,    // 10 miles in metres
                        fillColor: '#AA0000'
                    });
                    circle.bindTo('center', marker, 'position');
                    map.zoom = (circle.radius % 10) + 9
                    // switch(m.type) {
                    //     case "channel-new":
                    //         document.getElementById("channel_name").textContent = m.channel.name
                    //         document.getElementById("channel_descr").textContent = m.channel.description
                    //         break;
                    //     case "channel-update":
                    //         document.getElementById("channel_name").textContent = m.channel.name
                    //         document.getElementById("channel_descr").textContent = m.channel.description
                    //         break;
                    //     case "channel-delete":
                    //         document.getElementById("channel_name").textContent = ""
                    //         document.getElementById("channel_descr").textContent = ""
                    //         break;
                    //     case "message-new":
                    //         let c = document.getElementById("channel")
                    //         let p = document.createElement("p")
                    //         let s = document.createElement("span")
                    //         s.style.textIndent = "30px"
                    //         s.innerHTML = "by: " + m.message.creator.userName
                    //         s.id = "msg" + m.message.id
                    //         p.innerHTML = m.message.body
                    //         p.id = "msg" + m.message.id
                    //         c.appendChild(p)
                    //         c.appendChild(s)
                    //         break;
                    //     case "message-update":
                    //         let id = "msg" + m.message.id
                    //         let msg = document.getElementById(id)
                    //         msg.innerHTML = m.message.body
                    //         break; 
                    //     case "message-delete":
                    //         id = "msg" + m.message.id
                    //         msg = document.getElementById(id)
                    //         let span = document.getElementById(id)
                    //         msg.parentNode.removeChild(msg)
                    //         span.parentNode.removeChild(span)
                    //         break;
                    //}
                } else {
                    console.log(msg)
                }
                sock.send("IM ALIVE")
            };
        }
    </script>
    <script id="mapAPI" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvxUkdsobHEfyjJB7N-hzVyblrT4GRBdM&callback=initMap" asynch defer></script>
</body>

</html>
