<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, 
initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>New-Era</title>
    <link rel="stylesheet" 
href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
    <style>
        #map {
            height: 500px;
            width: 500px;
            float: right;
            margin-top: 20px;
        }
        h1 {
            text-align: center;
        }
        #data {
            display: inline;
        }
        #info {
            margin-top: 10%;
            float: left;
        }

        h4 {
            margin-bottom: 50px;
            font-weight: 300 bold;
        }
        span {
            font-size: 50px;
            color: red;
        }
        #time {
            margin-top: 100px;
            font-size: 25px;
            font-weight: 300 bold;
        }
    </style>
</head>

<body>
    <header class="jumbotron jumbotron-fluid">
        <div class="container">
            <h1>New-ERA</h1>
        </div>
    </header>
    <div class="container">
        <div>
            <div id="data">
                <div id="info">
                    <h4 hidden=true id="int">Expected Intensity: </h4>
                    <p hidden=true id="time"></p>
                </div>
            </div>
            <div id="map"></div>
            <button class="btn btn-info" onclick="demo();">Show Demo</button>
        </div>
    </div>
    <script>
        let sock;
        var map;
        var marker;
        var bounds;  
        const auth = localStorage.getItem('auth');
        submit();
        function initMap(lat, long) {
            if ((lat == null) || (long == null)) {
                lat = parseFloat(-34.397)
                long = parseFloat(150.644)
            }
            bounds = new google.maps.LatLngBounds(); 
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: lat, lng: long},
                zoom: 8
            
            });

            marker = new google.maps.Marker({
                position: map.center,
                map: map,
                title: 'Location of earthquake'
            });
            bounds.extend(marker.position)
        }

        function demo() {
            const http = new XMLHttpRequest();

            http.open("GET", "https://api.bfranzen.me/test")
            http.send();
        }
        function submit() {
            let token = auth;
            let res = document.getElementById("data");
            sock = new WebSocket("wss://api.bfranzen.me/ws?auth=" + token);
            sock.onopen = () => {
                console.log("Connection Opened");
                sock.send("connection open");
            };
            sock.onclose = () => {
                console.log("Connection Closed");
            };
            sock.onmessage = (msg) => {
                function IsJsonString(str) {
                    try {
                        JSON.parse(str);
                    } catch (e) {
                        return false;
                    }
                    return true;
                }
                if (IsJsonString(msg.data)) {
                    let m = JSON.parse(msg.data)
                    console.log(m)
                    let loc = m.location
                    let res = loc.split(",")
                    //map.center = {lat : parseFloat(res[0]), lng: parseFloat(res[1])}
                    //console.log(map.center)
                    //initMap(parseFloat(res[0]), parseFloat(res[1]))
                    initMap(parseFloat(res[0]), parseFloat(res[1]))

                    var circle = new google.maps.Circle({
                        map: map,
                        radius: 16000,    // 10 miles in metres
                        fillColor: '#AA0000'
                    });
                    circle.bindTo('center', marker, 'position');
                    map.zoom = (circle.radius % 10) + 9

                    let int = document.getElementById("int")
                    let time = document.getElementById("time")
                    time.hidden = false;
                    int.hidden = false;
                    int.innerHTML = int.innerHTML + " " + m.intensity + " <br/> <br/>" + m.message
                    time.innerHTML = time.innerHTML + m.time
                    let tmp = m.time
                    var t = setInterval(function() {
                        var left = tmp - 1
                        time.innerHTML = "Estimated <span>" + left + "</span>s until shaking"
                        if (left < 0) {
                            clearInterval(t);
                            document.getElementById("time").innerHTML = "EXPIRED";
                            time.hidden = true;
                        }
                        tmp = left
                    }, 1000)
                    var announce = setInterval(function() {
                        var msg = new SpeechSynthesisUtterance(m.message);
                        window.speechSynthesis.speak(msg);
                    }, 5000)
                
                } else {
                    console.log(msg)
                }
                sock.send("IM ALIVE")
            };
        }
    </script>
    <script id="mapAPI" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvxUkdsobHEfyjJB7N-hzVyblrT4GRBdM&callback=initMap" asynch defer></script>
</body>

</html>
